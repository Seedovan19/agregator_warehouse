# Описание работы рекомендательной системы
Рекомендательный алгоритм был реализован при помощи библиотек TensorFlow Recommenders и Keras.

<p>Это алгоритм является алгоритмом коллаборативной фильтрации с явным сбором данных - для сбора данных используется опрос: пользователь сам вручную вводит те параметры, которые хочет видеть у склада.</p>
<p>Алгоритм обучается выдавать оценки релевантности каждого склада запросу.</p>
<p>Важно отметить, что помимо набора параметров, есть такие атрибуты склада и такие пожелания пользователя, которые трудно учесть при простом математическом сравнении того, насколько сходятся параметры запроса и склада. В число таких атрибутов входит, например, стоимость услуг, оценки других клиентов об услугах складского провайдера, график работы склада и многие другие. Клиент может оставить дополнительный комментарий при создании запроса - любой текст с пожеланием, какой ему нужен склад. Эти параметры можно учесть только с помощью ручной оценки релевантности склада запросу.</p>
<p>Именно поэтому был необходим обучаемый алгоритм - он позволил учесть больше параметров.</p>
<p>Алгоритм при этом обучается для похожих запросов (по параметрам и местоположению) выдавать похожии рекомендации складов. Местоположение играет большую роль, потому что может быть два одинаковых запроса на склад, но в разных городах, именно поэтому все параметры представлены в виде текстовых токенов (токены выглядят так, например: "palletization", "refrigerator", "classA" - для склада класса А с холодильной камерой, оказывающего услуги палетизации), а координаты желаемого местоположения вынесены как отдельные атрибуты.</p>

<p>Таким образом, обученной модели на вход подаются параметры запроса, координаты желаемого местоположения и id любого склада и алгоритм выдает оценку, насколько данный склад подходит данному запросу.</p>

## Описание пайплайна машинного обучения
### preparation.py
<p>На первом шаге запускается программа в файле *preparation.py*. Производится получение данных о всех складах и запросах из базы данных через API от бекенда, написанного на Django. Затем производится разведочный анализ данных:</p>

* Определяется, в каких столбцах больше всего пропусков (если пропусков много в определенном столбце, то его можно удалить)
* Удаляются строки, в которых есть NaN-значения в столбцах, важных для подготовки обучающей выборки.
* Удаляются дублирующие строки


<p>После этого программа проходит по каждой отдельной паре склад-запрос. Задача: сравнить их атрибуты при помощи математических метрик и отсечь склады, которые точно не подходят. Производятся следующие действия:</p>

* Токенизируются атрибуты запроса и склада. Например, если у склада есть параметр транспортной доставки товаров, то в его строку параметров добавляется токен: "transport_services". Точно так же для запроса: если клиент ищет склад с морозильной камерой, к его строке запроса конкатенацией добавляется токен: "freezer". Таким образом появляется для каждой пары запрос-склад набор параметров, которые есть у склада и у запроса. 
* Для каждой пары высчитывается расстояние по формуле гаверсинуса от желаемого местоположения в запросе до реального расположения склада. Формула гаверсинуса представлена ниже:

<img width="763" alt="Снимок экрана 2022-07-09 в 22 48 12" src="https://user-images.githubusercontent.com/27068383/178120586-470d5944-1d53-48f4-aec2-0c1fd8fed73c.png">

* Также для каждой пары высчитывается "похожесть" их true/false-полей. Например, тех, о которых было сказано ранее: оказывает ли склад транспортные услуги (да/нет), есть ли морозильная камера. Формируются векторы склада и запроса и их похожесть считается при помощи коэффициента Жаккара: 

<img width="648" alt="Снимок экрана 2022-07-09 в 22 54 12" src="https://user-images.githubusercontent.com/27068383/178120756-280c0827-1616-41cc-8084-288871039fbb.png">

* Сохраняются координаты желаемого местоположения склада из запроса для каждой пары
* Есть параметры, принимающие только одно из ограниченного числа значений. Это класс склада и температурный режим (классы: "A+", "A", "B+", "B", "C"; температурные режимы: 'Не задано', 'Регулируемый температурный режим', 'Отапливаемый', 'Утепленный', 'Неотапливаемый', 'Морозильный', 'Холодильный'). Классы и температурные режимы в запросе и у склада сравниваются при помощи метрики взвешенного эвклидово расстояния (по сути данная метрика считает длину прямой по координатам двух точек, x-координата - это значение класса, а y-координата - это температурный режим):
<img width="1094" alt="Снимок экрана 2022-07-09 в 23 01 22" src="https://user-images.githubusercontent.com/27068383/178120917-f0f687c8-318f-458b-a5b7-19d399f43fad.png">

<p>Все рассчитанные параметры сохраняются в обучающей выборке.</p>
<p>После этого отсекаются склады, находящиеся на расстоянии более 300 км (ранее мы сохранили метрику расстояния от склада до желаемого местоположения, которое указал пользователь)</p>
<p>Столбец с эвклидовым расстоянием в обучающей выборке нормализуется, чтобы все значения были в диапазоне от нуля до единицы. Затем рассчитывается взвешенное среднее арифметическое между нормализованным расстоянием и коэффициентом Жаккара.</p>


<p></p>
<p></p>

* rating.csv
* training.py
* export
* connect.py

## Последовательность обучения и применения рекомендательного алгоритма
<img width="1382" alt="Снимок экрана 2022-07-09 в 15 52 07" src="https://user-images.githubusercontent.com/27068383/178106574-ad006eea-f92a-4373-9139-662f4ec15760.png">
